# R_calcul_hydrologique
library(shiny)
library(DBI)
library(RMySQL)
library(terra)  
library(sf)    
library(leaflet) 
library(dplyr)
library(DT)    ==============================================================================#                      CONFIGURATION BDD WAMP (MYSQL)# ==============================================================================# 
DB_NAME <- "INONDATION_DB"DB_HOST <- "127.0.0.1"DB_USER <- "root"DB_PASS <- ""         # DB_PORT <- 3306# --- FONCTION DE CONNEXION ---db_connect <- function() {  con <- tryCatch({    DBI::dbConnect(      RMySQL::MySQL(),      dbname = DB_NAME,      host = DB_HOST,      port = DB_PORT,      user = DB_USER,      password = DB_PASS    )  }, error = function(e) {    showNotification(paste("Erreur de connexion BDD:", e$message), type = "error", duration = 10)    NULL  })  return(con)}# Variable pour stocker le MNT globalement apr√®s l'uploadmnt_raster <- NULL # ==============================================================================#                                INTERFACE UTILISATEUR (UI)# ==============================================================================ui <- navbarPage("Application de Suivi d'Inondation Hydraulique",                                  tabPanel("üìù Saisie et Consultation",                          sidebarLayout(                            sidebarPanel(                              h3("Enregistrer une Nouvelle Mesure"),                              textInput("station_nom", "Nom de la Station:", "Riviere A - Pont 1"),                              numericInput("debit", "D√©bit (m¬≥/s):", 15.0, min = 0),                              numericInput("niveau_eau", "Niveau d'Eau (m):", 5.80, min = 0),                              actionButton("enregistrer", "Enregistrer la Donn√©e", class = "btn-primary"),                                                            hr(),                                                            h3("Supprimer une Entr√©e"),                              p("Entrez l'ID de la ligne √† supprimer."),                              numericInput("id_supprimer", "ID √† Supprimer:", 0),                              actionButton("supprimer", "Supprimer la Donn√©e", class = "btn-danger")                            ),                            mainPanel(                              h3("Derni√®res Donn√©es Enregistr√©es"),                              DT::dataTableOutput("table_bdd")                             )                          )                 ),                                  tabPanel("üó∫Ô∏è MNT & Calcul de Superficie",                          sidebarLayout(                            sidebarPanel(                              h3("1. Importer le MNT"),                              fileInput("upload_mnt", "Fichier MNT (GeoTIFF):", accept = ".tif"),                                                            hr(),                                                            h3("2. Calculer l'Inondation"),                              p("Utilise le dernier niveau d'eau enregistr√© pour calculer la superficie inond√©e."),                              actionButton("calculer_superficie", "Calculer & Mettre √† Jour BDD", class = "btn-success")                            ),                            mainPanel(                              h4("Statut MNT"),                              verbatimTextOutput("mnt_statut"),                                                            h4("R√©sultat du Dernier Calcul"),                              verbatimTextOutput("resultat_calcul")                            )                          )                 ),                                  tabPanel("üìç Carte des Zones Inondables",                          leafletOutput("carte_inondation", height = 700)                 ))# ==============================================================================#                                SERVEUR (LOGIQUE)# ==============================================================================server <- function(input, output, session) {    # ----------------------------------------------------  # REACTIVES: Gestion des donn√©es BDD  # ----------------------------------------------------    data_bdd <- reactiveVal(NULL)    observeEvent({    input$enregistrer     input$supprimer     input$calculer_superficie  }, {    con <- db_connect()    req(con)    on.exit(DBI::dbDisconnect(con))        req_sql <- "SELECT id, station_nom, niveau_eau, debit, date_heure, superficie_inondee FROM STATIONS_DONNEES ORDER BY date_heure DESC LIMIT 50"    data_bdd(DBI::dbGetQuery(con, req_sql))  }, ignoreInit = FALSE)    output$table_bdd <- DT::renderDT({    data_bdd()  })    # ----------------------------------------------------  # OBSERVERS: Actions BDD  # ----------------------------------------------------    # Enregistrement des donn√©es (INSERT) - CORRIG√â  observeEvent(input$enregistrer, {    con <- db_connect()    req(con)    on.exit(DBI::dbDisconnect(con))        req_insert <- paste0(      "INSERT INTO STATIONS_DONNEES (station_nom, debit, niveau_eau, date_heure) ",      "VALUES ('", input$station_nom, "', ", input$debit, ", ", input$niveau_eau, ", NOW())"    )    DBI::dbExecute(con, req_insert)    showNotification("Donn√©e enregistr√©e avec succ√®s.", type = "message")  })    # Suppression des donn√©es (DELETE)  observeEvent(input$supprimer, {    con <- db_connect()    req(con)    on.exit(DBI::dbDisconnect(con))        req_delete <- paste0("DELETE FROM STATIONS_DONNEES WHERE id = ", input$id_supprimer)    DBI::dbExecute(con, req_delete)    showNotification(paste("ID", input$id_supprimer, "supprim√©."), type = "warning")  })    # ----------------------------------------------------  # OBSERVERS: Gestion MNT et Calcul  # ----------------------------------------------------    # Importation et Diagnostic du MNT  observeEvent(input$upload_mnt, {    req(input$upload_mnt)    mnt_raster <<- terra::rast(input$upload_mnt$datapath)        mnt_min <- terra::minmax(mnt_raster)[1]    mnt_max <- terra::minmax(mnt_raster)[2]        output$mnt_statut <- renderText({      paste(        "MNT charg√© avec succ√®s!\n",        "R√©solution (taille cellule):", terra::res(mnt_raster)[1], "m x", terra::res(mnt_raster)[2], "m\n",        "Altitude Minimum:", round(mnt_min, 2), "m\n",        "Altitude Maximum:", round(mnt_max, 2), "m\n",        "Projection (CRS):", terra::crs(mnt_raster, describe=TRUE)$name, "\n",        "Assurez-vous que le Niveau d'Eau est > Altitude Minimum pour le calcul."      )    })  })    # Calcul de la Superficie & Mise √† jour BDD  observeEvent(input$calculer_superficie, {    req(mnt_raster)     req(data_bdd())         derniere_donnee <- data_bdd() %>% head(1)    req(derniere_donnee$niveau_eau, derniere_donnee$id)         niveau_eau_recent <- derniere_donnee$niveau_eau[1]    id_a_mettre_a_jour <- derniere_donnee$id[1]        # Cr√©er le masque inond√© : Z_MNT <= H_eau    masque_inonde <- mnt_raster <= niveau_eau_recent        # Calcul de la Superficie (en m¬≤)    cell_area <- terra::res(mnt_raster)[1] * terra::res(mnt_raster)[2]    superficie_m2 <- as.numeric(terra::global(masque_inonde, 'sum', na.rm=TRUE)) * cell_area        # Mise √† jour de la BDD    con <- db_connect()    req(con)    on.exit(DBI::dbDisconnect(con))        req_update <- paste0(      "UPDATE STATIONS_DONNEES SET superficie_inondee = ", round(superficie_m2, 2),       " WHERE id = ", id_a_mettre_a_jour    )    DBI::dbExecute(con, req_update)        output$resultat_calcul <- renderText(paste(      "Calcul termin√©.\n",      "Niveau d'eau utilis√©:", niveau_eau_recent, "m\n",      "Superficie inond√©e:", round(superficie_m2 / 1000000, 2), "km¬≤ (", round(superficie_m2, 2), " m¬≤).\n",      "Mise √† jour de l'ID", id_a_mettre_a_jour, "dans la BDD."    ))    # Correction de l'erreur: type doit √™tre "default", "message", "warning" ou "error"    showNotification("Calcul et mise √† jour BDD termin√©s.", type = "message")  })    # ----------------------------------------------------  # RENDU: Carte Leaflet (CORRIG√â)  # ----------------------------------------------------    output$carte_inondation <- renderLeaflet({    req(mnt_raster)    req(data_bdd())        derniere_donnee <- data_bdd() %>% head(1)    niveau_eau_recent <- derniere_donnee$niveau_eau[1]        # Cr√©ation du masque (Z_MNT <= H_eau)    masque_inonde <- mnt_raster <= niveau_eau_recent        # Conversion du masque raster en polygone sf    polygone_inonde <- masque_inonde %>%       terra::as.polygons(dissolve = TRUE) %>%       sf::st_as_sf()        # --- CORRECTION DE LA PROJECTION POUR LEAFLET ---    # Leaflet exige des coordonn√©es Lat/Lon (WGS 84 / EPSG:4326)    if (nrow(polygone_inonde) > 0) {      # V√©rifie si le CRS actuel n'est pas d√©j√† 4326      if (sf::st_crs(polygone_inonde)$epsg != 4326) {        polygone_inonde <- sf::st_transform(polygone_inonde, crs = 4326)        showNotification("Reprojection du MNT en WGS 84 effectu√©e.", type = "message", duration = 3)      }    }    # -----------------------------------------------        # V√©rification des polygones vides    if (nrow(polygone_inonde) == 0) {      return(leaflet() %>% addTiles() %>%                setView(lng = 0, lat = 0, zoom = 2) %>%                addControl("Aucune zone inondable d√©tect√©e. Augmentez le Niveau d'Eau saisi ou v√©rifiez le MNT.", position = "topright")      )    }        # Cr√©ation et affichage de la carte    map <- leaflet() %>%      addTiles(group = "OSM (Par d√©faut)") %>%        addProviderTiles(providers$CartoDB.Positron, group = "Clair") %>%            # Affichage des zones inond√©es      addPolygons(        data = polygone_inonde,        fillColor = "blue",        color = "darkblue",        weight = 2,        opacity = 0.8,        fillOpacity = 0.4,        popup = ~paste0("Zone Inond√©e (Niveau:", niveau_eau_recent, "m)")      ) %>%       addLayersControl(        baseGroups = c("OSM (Par d√©faut)", "Clair"),        overlayGroups = c("Zone Inond√©e"),        options = layersControlOptions(collapsed = FALSE)      )        # Zoom initial    map <- map %>% leaflet::fitBounds(      lng1 = st_bbox(polygone_inonde)["xmin"],      lat1 = st_bbox(polygone_inonde)["ymin"],      lng2 = st_bbox(polygone_inonde)["xmax"],      lat2 = st_bbox(polygone_inonde)["ymax"]    )        return(map)  })}# Lancement de l'applicationshinyApp(ui = ui, server = server)
